name: Go Cross-Platform Build and Release

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [ linux, windows, darwin ]
        goarch: [ amd64, arm64 ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23.3'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          BINARY_NAME="receivepay-${GOOS}-${GOARCH}"
          if [ "$GOOS" == "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          echo "Building $BINARY_NAME ..."
          go build -v -o "$BINARY_NAME" ./cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: receivepay-*
          if-no-files-found: error

  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare Release Assets
        run: |
          # Create individual packages for each platform
          mkdir -p release-packages

          # Find all binaries in all-artifacts
          # Structure is likely: all-artifacts/binary-linux-amd64/receivepay-linux-amd64
          # We want to iterate and package them.

          # We know the matrix: linux/amd64, linux/arm64, windows/amd64, windows/arm64, darwin/amd64, darwin/arm64
          platforms=("linux/amd64" "linux/arm64" "windows/amd64" "windows/arm64" "darwin/amd64" "darwin/arm64")

          for platform in "${platforms[@]}"; do
            os=$(echo $platform | cut -d'/' -f1)
            arch=$(echo $platform | cut -d'/' -f2)
          
            # Construct binary name based on build job
            bin_name="receivepay-${os}-${arch}"
            if [ "$os" == "windows" ]; then
              bin_name="${bin_name}.exe"
            fi
          
            # Find the binary file
            bin_path=$(find all-artifacts -name "$bin_name" -type f | head -n 1)
          
            if [ -z "$bin_path" ]; then
              echo "Warning: Binary for $platform not found at $bin_name"
              continue
            fi
          
            echo "Packaging $platform from $bin_path..."
          
            # Create a temporary directory for packaging
            pkg_dir="receivepay-${os}-${arch}"
            mkdir -p "$pkg_dir"
          
            # Copy binary
            cp "$bin_path" "$pkg_dir/"
          
            # Copy resources
            cp -r conf static go.mod "$pkg_dir/"
          
            # Create archive
            if [ "$os" == "windows" ]; then
              zip -r "release-packages/${pkg_dir}.zip" "$pkg_dir"
            else
              tar -czf "release-packages/${pkg_dir}.tar.gz" "$pkg_dir"
            fi
          
            # Clean up temp dir
            rm -rf "$pkg_dir"
          done

          ls -R release-packages

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME=$(date +'v%Y.%m.%d-%H%M%S')
          echo "Creating release $TAG_NAME"

          RELEASE_NOTES="## Auto Receive Crypto Pay

          ### Release $TAG_NAME

          Instructions: https://github.com/HEUDavid/auto-receive-crypto-pay"

          gh release create "$TAG_NAME" release-packages/* \
            --title "Release $TAG_NAME" \
            --notes "$RELEASE_NOTES" \
            --draft=false
